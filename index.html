<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Tree Editor (Firebase & D3.js)</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load D3.js v7 library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Custom styling for the tree container */
    #tree-container { 
        width: 100%; 
        height: 90vh; 
        background-color: #f7f7f7;
        border-radius: 0.5rem;
        overflow: hidden; 
    }
    
    /* D3 Styles */
    .link {
      fill: none;
      stroke: #9d9d9d;
      stroke-width: 1.5px;
    }
    .node rect {
      fill: #fff;
      stroke: #3182CE;
      stroke-width: 2px;
      cursor: pointer;
      rx: 6; ry: 6;
    }
    .node text {
      font-size: 11px; font-weight: 500; fill: #333; pointer-events: none; 
      text-anchor: middle; dominant-baseline: middle; 
    }
    .node--root rect { fill: #3182CE; stroke: #2C5282; }
    .node--root text { fill: white; font-weight: bold; }

    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen font-sans">
  
  <header class="mb-6 text-center w-full max-w-6xl">
      <h1 class="text-3xl font-bold text-indigo-700">The Family Tree of Jia Liok Ngo</h1>
      
      <div id="controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
          
          <!-- Public Request Button (Always Visible) -->
          <a href="mailto:bryantaryadi25@gmail.com?subject=New%20Family%20Member%20Addition%20Request%20(Jia%20Liok%20Ngo%20Tree)&body=Hello%20Bryant%2C%0D%0A%0D%0AI%20would%20like%20to%20request%20the%20addition%20of%20a%20new%20family%20member%20to%20the%20tree.%0D%0A%0D%0A---%20Required%20Details%20---%0D%0A-Name%20of%20New%20Member%3A%0D%0A-Parent's%20Name%20(Existing%20on%20Tree)%3A%0D%0A-Relationship%20(e.g.%2C%20Child%2C%20Spouse)%3A%0D%0A---%20%0D%0A%0D%0AThanks!" 
             class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition duration-150">
              + Request New Member Addition
          </a>
          
          <!-- Admin Controls Group -->
          <div id="adminControls" class="flex items-center space-x-2">
            <!-- Admin Edit Button (Hidden by default, shown after admin sign-in) -->
            <button id="editButton" class="hidden items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition duration-150" onclick="openEditModal()">
                Admin: Edit Tree Data
            </button>

            <!-- Admin Sign Out Button (New) -->
            <button id="signOutButton" class="hidden items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 transition duration-150" onclick="adminSignOut()">
                Sign Out
            </button>
          </div>

          <!-- Admin Login Button -->
          <button id="loginButton" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150" onclick="openLoginModal()">
              Admin Login
          </button>
          
          <div id="authStatus" class="text-sm text-gray-500">Initializing...</div>
      </div>
  </header>

  <div id="tree-container" class="w-full max-w-6xl shadow-xl rounded-lg border border-gray-200">
    <svg id="tree"></svg>
  </div>
  
  <!-- Modal for Admin Login (NEW/FIXED) -->
  <div id="loginModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Admin Login</h2>
      
      <div class="space-y-4">
        <div>
          <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="adminEmail" placeholder="Enter admin email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="adminPassword" placeholder="Enter password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>

      <div id="loginError" class="text-red-500 text-sm mt-4 hidden"></div>

      <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeLoginModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="handleAdminLogin()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Login</button>
      </div>
    </div>
  </div>

  <!-- Modal for Data Editing -->
  <div id="editModal" class="modal-overlay hidden">
    <div class="modal-content max-w-600px">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Edit Family Tree JSON</h2>
      <p class="text-sm text-red-600 mb-4">CAUTION: This directly edits the live database. Ensure the JSON structure remains correct!</p>
      
      <textarea id="jsonEditor" rows="15" class="w-full p-3 border border-gray-300 rounded-md font-mono text-xs"></textarea>

      <div id="editError" class="text-red-500 text-sm mt-2 hidden"></div>

      <div class="flex justify-end space-x-3 mt-4">
        <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="saveData()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Changes</button>
      </div>
    </div>
  </div>


  <!-- Firebase and D3 Logic -->
  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAPoBkkYoYpHxq5EB36iqSCzSPA6Y4xVDw",
        authDomain: "familytreeapp-70fd0.firebaseapp.com",
        projectId: "familytreeapp-70fd0",
        storageBucket: "familytreeapp-70fd0.firebasestorage.app",
        messagingSenderId: "581868402894",
        appId: "1:581868402894:web:64a96854cf7badfc54b89f",
        measurementId: "G-Z2LLBDS6RQ"
    };
    
    // --- ADMIN LIST: Add UIDs of all users who should have edit permissions here ---
    const ADMIN_UIDS = [
        "8rO5MWkS5LM58YVyFbCuHZOhsoJ3", // The original primary admin
        // Add more UIDs for new administrators here!
    ];

    const appId = firebaseConfig.projectId;
    
    // --- FIREBASE SETUP ---
    setLogLevel('debug'); 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Document reference 
    const treeDocRef = doc(db, `artifacts/${appId}/public/data/familyTree/current`);
    
    let currentTreeData = null;
    let userId = null;

    // --- LOGIN MODAL FUNCTIONS (NEW) ---
    
    window.openLoginModal = function() {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminPassword').value = '';
    }

    window.closeLoginModal = function() {
        document.getElementById('loginModal').classList.add('hidden');
    }

    // Function to handle the actual sign-in from the modal
    window.handleAdminLogin = async function() {
        const emailInput = document.getElementById('adminEmail');
        const passwordInput = document.getElementById('adminPassword');
        const loginError = document.getElementById('loginError');

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        loginError.classList.add('hidden');
        
        if (!email || !password) {
            loginError.textContent = "Please enter both email and password.";
            loginError.classList.remove('hidden');
            return;
        }

        try {
            // Note: This signs in any valid Firebase Auth user.
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Admin signed in successfully!"); 
            closeLoginModal(); // Close modal on success
        } catch (error) {
            // Display error message inside the modal
            console.error("Admin Sign In Error:", error.message);
            loginError.textContent = "Login failed. Check your email and password.";
            loginError.classList.remove('hidden');
        }
    }
    
    // Function to handle admin sign out 
    window.adminSignOut = async function() {
        try {
            await signOut(auth);
            console.log("Admin signed out successfully!");
        } catch (error) {
            console.error("Sign Out Error:", error.message);
            // Replaced alert with console error as the UI will naturally update.
        }
    }

    // Check for existing signed-in user (only relevant for the Admin)
    onAuthStateChanged(auth, (user) => {
        userId = user ? user.uid : null;
        const authStatusElement = document.getElementById('authStatus');
        const editButton = document.getElementById('editButton');
        const signOutButton = document.getElementById('signOutButton');
        const loginButton = document.getElementById('loginButton');

        // CRITICAL CHECK: Determine if the currently signed-in user is an Admin
        const isUserAdmin = userId && ADMIN_UIDS.includes(userId);

        if (isUserAdmin) {
            authStatusElement.innerHTML = `<span class="text-green-600 font-bold">ADMIN MODE (Signed In)</span>`;
            
            // Show Admin controls
            editButton.classList.remove('hidden');
            editButton.classList.add('flex');
            signOutButton.classList.remove('hidden'); 
            signOutButton.classList.add('flex');
            loginButton.classList.add('hidden'); // HIDE LOGIN
        } else {
            // Everyone else is a viewer, whether signed in or not.
            authStatusElement.innerHTML = `<span class="text-gray-500">View Only Mode</span>`;
            
            // Hide Admin controls
            editButton.classList.add('hidden');
            editButton.classList.remove('flex');
            signOutButton.classList.add('hidden'); 
            signOutButton.classList.remove('flex');
            loginButton.classList.remove('hidden'); // SHOW LOGIN
        }
    });

    // --- DATA HANDLING (READ) ---
    function loadTreeData() {
        // Listen for real-time changes to the tree document
        onSnapshot(treeDocRef, (docSnap) => {
            // UI state check: the onAuthStateChanged handles the main status, but this ensures a quick view-only update if needed
            if (auth.currentUser === null || !ADMIN_UIDS.includes(auth.currentUser.uid)) {
                 document.getElementById('authStatus').innerHTML = `<span class="text-gray-500">View Only Mode</span>`;
            }

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.treeJson) {
                    try {
                        const treeObject = JSON.parse(data.treeJson);
                        currentTreeData = treeObject;
                        drawTree(currentTreeData);
                        console.log("Tree data loaded from Firestore.");
                    } catch (e) {
                        console.error("Error parsing JSON data from Firestore:", e);
                    }
                } else {
                    currentTreeData = { name: "Tree Document Empty" };
                    drawTree(currentTreeData);
                }
            } else {
                currentTreeData = { name: "Jia Liok Ngo (Database Not Initialized)" };
                drawTree(currentTreeData);
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            const authStatusElement = document.getElementById('authStatus');
            
            // This error now only occurs if the security rules are too strict!
            if (error.code === 'permission-denied') {
                authStatusElement.innerHTML = `<p class="text-xs text-red-500 font-bold mt-1">Error: Permission Denied. Please ensure the Firestore security rules allow unauthenticated public reads.</p>`;
                currentTreeData = { name: "Error: Permission Denied" };
                drawTree(currentTreeData);
            }
        });
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
    }

    loadTreeData();

    function resizeHandler() {
        if (currentTreeData) {
            drawTree(currentTreeData);
        }
    }

    // --- DATA HANDLING (WRITE) & D3 LOGIC ---
    const initialJsonStructure = {
      name: "Jia Liok Ngo (Ancestor)", 
      children: [
        { name: "johnny", children: [{ name: "Magdalena" }, { name: "Yunita", children: [{ name: "Vince" }, { name: "Gwen" }] }, { name: "Juliana" }] },
        { name: "katerin" },
        { name: "justin", children: [{ name: "Yan", children: [{ name: "prina" }, { name: "nerva", children: [{ name: "razya" }] }, { name: "wiwin", children: [{ name: "lovna" }, { name: "ale" }] }] }, { name: "Op", children: [{ name: "irene", children: [{ name: "gemma" }] }, { name: "astrid" }] }, { name: "Irvan", children: [{ name: "fanny", children: [{ name: "mikha" }] }, { name: "vivian" }] }, { name: "yanty", children: [{ name: "janice" }, { name: "geo" }] }, { name: "wina", children: [{ name: "anet" }, { name: "serlin" }] }, { name: "irsan" }] },
        { name: "diana" },
        { name: "liance", children: [{ name: "nini", children: [{ name: "jason" }, { name: "janice" }] }, { name: "titi", children: [{ name: "justin" }, { name: "julian" }] }, { name: "tina", children: [{ name: "jeremy" }] }, { name: "victor", children: [{ name: "monic" }, { name: "jace" }] }] },
        { name: "tresnawati", children: [{ name: "vidya", children: [{ name: "Niko" }, { name: "Andre" }, { name: "Madeline" }] }, { name: "Viko", children: [{ name: "Adeline" }] }, { name: "Theo", children: [{ name: "Gerald" }, { name: "Kevin" }, { name: "Adelle" }] }, { name: "Siska", children: [{ name: "Angel" }, { name: "Nalda" }, { name: "Casia" }] }, { name: "Keke", children: [{ name: "Aldrich" }, { name: "Bryant (thatâ€™s me)" }, { name: "Christy" }] }] }
      ]
    };
    
    window.openEditModal = function() {
        document.getElementById('editError').classList.add('hidden');
        document.getElementById('jsonEditor').value = JSON.stringify(currentTreeData || initialJsonStructure, null, 2);
        document.getElementById('editModal').classList.remove('hidden');
    }

    window.closeEditModal = function() {
        document.getElementById('editModal').classList.add('hidden');
    }

    window.saveData = async function() {
        const jsonEditor = document.getElementById('jsonEditor');
        const editError = document.getElementById('editError');
        editError.classList.add('hidden');

        try {
            const updatedData = JSON.parse(jsonEditor.value);
            const dataToSave = {
                treeJson: JSON.stringify(updatedData)
            };
            await setDoc(treeDocRef, dataToSave, { merge: false });
            console.log("Data successfully saved to Firestore!");
            closeEditModal();
        } catch (e) {
            editError.textContent = "Error saving data: Invalid JSON format or database error.";
            editError.classList.remove('hidden');
            console.error("Save Error:", e);
        }
    }

    const nodeWidth = 100;
    const nodeHeight = 30;

    function drawTree(data) {
        if (!data || !data.name) return; 

        const container = document.getElementById('tree-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select("#tree")
            .attr("width", width)
            .attr("height", height);

        svg.selectAll('*').remove();

        const g = svg.append("g")
            .attr("transform", "translate(40,40)"); 

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4]) 
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        const treeLayout = d3.tree()
            .nodeSize([nodeHeight + 20, nodeWidth + 60]); 
            
        const root = d3.hierarchy(data);
        treeLayout(root);

        g.selectAll(".link")
            .data(root.links()) 
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y) 
                .y(d => d.x)); 

        const node = g.selectAll(".node")
            .data(root.descendants()) 
            .enter().append("g")
            .attr("class", d => "node" + (d.depth === 0 ? " node--root" : ""))
            .attr("transform", d => `translate(${d.y},${d.x})`); 

        node.append("rect")
            .attr("width", nodeWidth)
            .attr("height", nodeHeight)
            .attr("x", -(nodeWidth / 2))
            .attr("y", -(nodeHeight / 2)); 

        node.append("text")
            .attr("x", 0) 
            .attr("y", 0) 
            .text(d => d.data.name); 

        const initialScale = 0.7;
        svg.call(zoom.transform, d3.zoomIdentity
            .translate(width / 4, height / 2) 
            .scale(initialScale)
        );
    }
  </script>
</body>
</html>
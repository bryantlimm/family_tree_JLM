

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Tree Editor (Firebase & D3.js)</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load D3.js v7 library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Custom styling for the tree container */
    #tree-container { 
        width: 100%; 
        height: 90vh; 
        background-color: #f7f7f7;
        border-radius: 0.5rem;
        overflow: hidden; 
    }
    
    /* D3 Styles */
    .link {
      fill: none;
      stroke: #9d9d9d;
      stroke-width: 1.5px;
    }
    .node rect {
      fill: #fff;
      stroke: #3182CE;
      stroke-width: 2px;
      cursor: default; /* Default cursor for view-only */
      rx: 6; ry: 6;
    }
    /* Admin mode indicates nodes are clickable */
    .node--admin rect {
      stroke: #E53E3E; /* Red border */
      stroke-width: 3px;
      cursor: pointer;
    }
    .node text {
      font-size: 11px; font-weight: 500; fill: #333; pointer-events: none; 
      text-anchor: middle; dominant-baseline: middle; 
    }
    .node--root rect { fill: #3182CE; stroke: #2C5282; }
    .node--root text { fill: white; font-weight: bold; }
    .node--root.node--admin rect { stroke: #D53F8C; } /* Root node admin color */

    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 450px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen font-sans">
  
  <header class="mb-6 text-center w-full max-w-6xl">
      <h1 class="text-3xl font-bold text-indigo-700">The Family Tree of Jia Liok Ngo</h1>
      
      <div id="controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
          
          <!-- Public Request Button (Always Visible) -->
          <a href="mailto:bryantaryadi25@gmail.com?subject=New%20Family%20Member%20Addition%20Request%20(Jia%20Liok%20Ngo%20Tree)&body=Hello%20Bryant%2C%0D%0A%0D%0AI%20would%20like%20to%20request%20the%20addition%20of%20a%20new%20family%20member%20to%20the%20tree.%0D%0A%0D%0A---%20Required%20Details%20---%0D%0A-Name%20of%20New%20Member%3A%0D%0A-Parent's%20Name%20(Existing%20on%20Tree)%3A%0D%0A-Relationship%20(e.g.%2C%20Child%2C%20Spouse)%3A%0D%0A---%20%0D%0A%0D%0AThanks!" 
             class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition duration-150">
              + Request New Member Addition
          </a>
          
          <!-- Admin Controls Group -->
          <div id="adminControls" class="flex items-center space-x-2">
            
            <!-- Password Change Button -->
            <button id="passwordButton" class="hidden items-center px-3 py-2 text-xs font-medium rounded-md text-gray-800 bg-yellow-400 hover:bg-yellow-500 transition duration-150" onclick="openPasswordChangeModal()">
                Password
            </button>

            <!-- Admin Sign Out Button -->
            <button id="signOutButton" class="hidden items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 transition duration-150" onclick="adminSignOut()">
                Sign Out
            </button>
          </div>

          <!-- Admin Login Button -->
          <button id="loginButton" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150" onclick="openLoginModal()">
              Admin Login
          </button>
          
          <div id="authStatus" class="text-sm text-gray-500">Initializing...</div>
      </div>
  </header>

  <div id="tree-container" class="w-full max-w-6xl shadow-xl rounded-lg border border-gray-200">
    <svg id="tree"></svg>
  </div>
  
  <!-- Modal for Admin Login -->
  <div id="loginModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Admin Login</h2>
      
      <div class="space-y-4">
        <div>
          <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="adminEmail" placeholder="Enter admin email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="adminPassword" placeholder="Enter password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>

      <div id="loginError" class="text-red-500 text-sm mt-4 hidden"></div>

      <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeLoginModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="handleAdminLogin()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Login</button>
      </div>
    </div>
  </div>

  <!-- Modal for Password Change -->
  <div id="passwordChangeModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-yellow-700">Change Admin Password</h2>
      <p class="text-sm text-gray-600 mb-4">You must enter your current password to confirm your identity.</p>

      <div class="space-y-4">
        <div>
          <label for="currentPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password (Min 6 chars)</label>
          <input type="password" id="newPassword" placeholder="Enter new password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div>
          <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" placeholder="Re-enter new password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
      </div>

      <div id="passwordChangeError" class="text-red-500 text-sm mt-4 hidden"></div>
      <div id="passwordChangeSuccess" class="text-green-600 text-sm mt-4 hidden"></div>

      <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closePasswordChangeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="changePassword()" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">Update Password</button>
      </div>
    </div>
  </div>

  <!-- Modal for Node Editing (NEW) -->
  <div id="nodeEditModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-red-700">Edit Member: <span id="currentMemberName" class="font-extrabold"></span></h2>
      <input type="hidden" id="currentMemberPath">

      <div class="space-y-4">
        
        <!-- 1. Edit Name Section -->
        <div>
          <label for="newName" class="block text-sm font-medium text-gray-700">Change Name</label>
          <input type="text" id="newName" placeholder="New Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          <button onclick="handleNodeAction('rename')" class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">Rename Member</button>
        </div>
        
        <hr class="border-gray-200">

        <!-- 2. Add Child Section -->
        <div>
          <label for="childName" class="block text-sm font-medium text-gray-700">Add New Child</label>
          <input type="text" id="childName" placeholder="New Child's Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          <button onclick="handleNodeAction('addChild')" class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition">Add Child</button>
        </div>

        <hr class="border-gray-200">

        <!-- 3. Delete Section -->
        <div id="deleteSection">
          <p class="text-red-500 text-sm font-semibold mb-2">Danger Zone: Remove Member</p>
          <button onclick="handleNodeAction('delete')" class="w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition">Delete Member (and all descendants)</button>
        </div>

      </div>

      <div id="nodeEditError" class="text-red-500 text-sm mt-4 hidden"></div>
      <div id="nodeEditSuccess" class="text-green-600 text-sm mt-4 hidden"></div>

      <div class="flex justify-end mt-6">
        <button onclick="closeNodeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Done</button>
      </div>
    </div>
  </div>


  <!-- Firebase and D3 Logic -->
  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAPoBkkYoYpHxq5EB36iqSCzSPA6Y4xVDw",
        authDomain: "familytreeapp-70fd0.firebaseapp.com",
        projectId: "familytreeapp-70fd0",
        storageBucket: "familytreeapp-70fd0.firebasestorage.app",
        messagingSenderId: "581868402894",
        appId: "1:581868402894:web:64a96854cf7badfc54b89f",
        measurementId: "G-Z2LLBDS6RQ"
    };
    
    // --- ADMIN LIST: Add UIDs of all users who should have edit permissions here ---
    const ADMIN_UIDS = [
        "8rO5MWkS5LM58YVyFbCuHZOhsoJ3", 
        "n0qGW5dZOROudfx5kS4OLXl8dvv2"
    ];

    const appId = firebaseConfig.projectId;
    
    // --- FIREBASE SETUP ---
    setLogLevel('debug'); 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Document reference 
    const treeDocRef = doc(db, `artifacts/${appId}/public/data/familyTree/current`);
    
    let currentTreeData = null;
    let userId = null;
    let isAdminMode = false; // NEW global state for edit mode

    // --- UTILITY FUNCTIONS FOR TREE MANIPULATION ---
    
    // Recursive function to find the node and its parent, using an array of names as the path
    function findNodeAndParent(node, path, index = 0, parent = null) {
        if (!node || index >= path.length) return { node: null, parent: null };
        
        if (node.name === path[index]) {
            if (index === path.length - 1) {
                // Found the target node
                return { node, parent };
            }
            
            // Continue search in children
            if (node.children) {
                for (const child of node.children) {
                    const result = findNodeAndParent(child, path, index + 1, node);
                    if (result.node) {
                        return result;
                    }
                }
            }
        }
        return { node: null, parent: null };
    }

    // Function to create a unique path (array of names from root to node) for a D3 node
    function getPath(d) {
        let path = [];
        let current = d;
        while (current) {
            path.unshift(current.data.name);
            current = current.parent;
        }
        // Slice the first element (which is the root name, usually "Jia Liok Ngo...") 
        // We only need the path starting from the root's children downwards.
        return path;
    }

    // --- MODAL & ACTION HANDLERS ---

    // Global variable to store the path of the node currently being edited
    let activeNodePath = [];

    window.openNodeEditModal = function(d) {
        activeNodePath = getPath(d);
        const memberName = d.data.name;
        
        document.getElementById('currentMemberName').textContent = memberName;
        document.getElementById('newName').value = memberName;
        document.getElementById('childName').value = '';
        document.getElementById('nodeEditError').classList.add('hidden');
        document.getElementById('nodeEditSuccess').classList.add('hidden');
        
        // Hide delete option for the root node (first element of the path array)
        if (activeNodePath.length === 1) {
             document.getElementById('deleteSection').classList.add('hidden');
        } else {
             document.getElementById('deleteSection').classList.remove('hidden');
        }

        document.getElementById('nodeEditModal').classList.remove('hidden');
    }

    window.closeNodeEditModal = function() {
        document.getElementById('nodeEditModal').classList.add('hidden');
    }

    window.handleNodeAction = async function(action) {
        const errorElement = document.getElementById('nodeEditError');
        const successElement = document.getElementById('nodeEditSuccess');
        errorElement.classList.add('hidden');
        successElement.classList.add('hidden');
        
        // Use a mutable copy of the current data
        let newTreeData = JSON.parse(JSON.stringify(currentTreeData)); 

        const { node: targetNode, parent: targetParent } = findNodeAndParent(newTreeData, activeNodePath);

        if (!targetNode) {
            errorElement.textContent = "Error: Could not find the selected member in the tree data.";
            errorElement.classList.remove('hidden');
            return;
        }
        
        let shouldSave = false;

        switch (action) {
            case 'rename':
                const newName = document.getElementById('newName').value.trim();
                if (!newName) {
                    errorElement.textContent = "Name cannot be empty.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                targetNode.name = newName;
                shouldSave = true;
                successElement.textContent = "Member successfully renamed to " + newName + "!";
                // Update the path reference to the new name for future actions
                activeNodePath[activeNodePath.length - 1] = newName; 
                document.getElementById('currentMemberName').textContent = newName;
                document.getElementById('newName').value = newName;
                break;

            case 'addChild':
                const childName = document.getElementById('childName').value.trim();
                if (!childName) {
                    errorElement.textContent = "Child's name cannot be empty.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                if (!targetNode.children) {
                    targetNode.children = [];
                }
                targetNode.children.push({ name: childName });
                shouldSave = true;
                successElement.textContent = childName + " successfully added as a child!";
                document.getElementById('childName').value = '';
                break;
                
            case 'delete':
                if (activeNodePath.length === 1 || !targetParent) {
                    errorElement.textContent = "Cannot delete the root node.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // Remove the node from the parent's children array
                targetParent.children = targetParent.children.filter(child => child.name !== targetNode.name);
                
                // If parent has no more children, remove the children array entirely
                if (targetParent.children.length === 0) {
                    delete targetParent.children;
                }
                
                shouldSave = true;
                successElement.textContent = targetNode.name + " and their descendants have been removed.";
                break;
        }

        if (shouldSave) {
            try {
                const dataToSave = { treeJson: JSON.stringify(newTreeData) };
                await setDoc(treeDocRef, dataToSave, { merge: false });
                currentTreeData = newTreeData; // Update the live variable
                // The onSnapshot listener will redraw the tree.
                console.log("Tree data successfully updated and saved to Firestore.");
            } catch (e) {
                errorElement.textContent = "Error saving data to database.";
                errorElement.classList.remove('hidden');
                console.error("Save Error:", e);
            }
        }

        successElement.classList.remove('hidden');
    }


    // --- AUTH & LOGIN FUNCTIONS (Kept from previous version) ---

    window.openLoginModal = function() {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminPassword').value = '';
    }

    window.closeLoginModal = function() {
        document.getElementById('loginModal').classList.add('hidden');
    }

    window.handleAdminLogin = async function() {
        const emailInput = document.getElementById('adminEmail');
        const passwordInput = document.getElementById('adminPassword');
        const loginError = document.getElementById('loginError');

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        loginError.classList.add('hidden');
        
        if (!email || !password) {
            loginError.textContent = "Please enter both email and password.";
            loginError.classList.remove('hidden');
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Admin signed in successfully!"); 
            closeLoginModal(); 
        } catch (error) {
            console.error("Admin Sign In Error:", error.message);
            loginError.textContent = "Login failed. Check your email and password.";
            loginError.classList.remove('hidden');
        }
    }
    
    window.adminSignOut = async function() {
        try {
            await signOut(auth);
            console.log("Admin signed out successfully!");
        } catch (error) {
            console.error("Sign Out Error:", error.message);
        }
    }

    // Password Change Functions (Kept from previous version)
    window.openPasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').classList.remove('hidden');
        document.getElementById('passwordChangeError').classList.add('hidden');
        document.getElementById('passwordChangeSuccess').classList.add('hidden');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
    }

    window.closePasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').classList.add('hidden');
    }

    window.changePassword = async function() {
        const user = auth.currentUser;
        if (!user || !user.email) {
            document.getElementById('passwordChangeError').textContent = "Not signed in or user data missing.";
            document.getElementById('passwordChangeError').classList.remove('hidden');
            return;
        }

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const errorElement = document.getElementById('passwordChangeError');
        const successElement = document.getElementById('passwordChangeSuccess');

        errorElement.classList.add('hidden');
        successElement.classList.add('hidden');

        if (newPassword.length < 6) {
            errorElement.textContent = "New password must be at least 6 characters long.";
            errorElement.classList.remove('hidden');
            return;
        }

        if (newPassword !== confirmNewPassword) {
            errorElement.textContent = "New passwords do not match.";
            errorElement.classList.remove('hidden');
            return;
        }

        try {
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);

            successElement.textContent = "Password successfully updated!";
            successElement.classList.remove('hidden');
            document.getElementById('currentPassword').value = ''; 
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';

            setTimeout(closePasswordChangeModal, 2000); 
            
        } catch (error) {
            console.error("Password Change Error:", error);
            
            let message = "An unknown error occurred.";
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = "Current password is incorrect.";
            } else if (error.code === 'auth/requires-recent-login') {
                message = "Please sign out and sign back in before changing your password.";
            } else if (error.code === 'auth/weak-password') {
                message = "The new password is too weak. Please choose a stronger one.";
            } else {
                message = error.message;
            }

            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
    }


    // Check for existing signed-in user
    onAuthStateChanged(auth, (user) => {
        userId = user ? user.uid : null;
        const authStatusElement = document.getElementById('authStatus');
        const signOutButton = document.getElementById('signOutButton');
        const passwordButton = document.getElementById('passwordButton'); 
        const loginButton = document.getElementById('loginButton');

        const isUserAdmin = userId && ADMIN_UIDS.includes(userId);
        isAdminMode = isUserAdmin; // Update the global state

        // Re-draw the tree to apply the admin styling and click handlers
        if(currentTreeData) {
            drawTree(currentTreeData);
        }

        if (isAdminMode) {
            authStatusElement.innerHTML = `<span class="text-green-600 font-bold">ADMIN MODE (Click a member to edit)</span>`;
            
            signOutButton.classList.remove('hidden'); 
            signOutButton.classList.add('flex');
            passwordButton.classList.remove('hidden'); 
            passwordButton.classList.add('flex');
            loginButton.classList.add('hidden'); 
        } else {
            authStatusElement.innerHTML = `<span class="text-gray-500">View Only Mode</span>`;
            
            signOutButton.classList.add('hidden'); 
            signOutButton.classList.remove('flex');
            passwordButton.classList.add('hidden'); 
            passwordButton.classList.remove('flex');
            loginButton.classList.remove('hidden'); 
        }
    });

    // --- DATA HANDLING (READ) ---
    function loadTreeData() {
        onSnapshot(treeDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.treeJson) {
                    try {
                        const treeObject = JSON.parse(data.treeJson);
                        currentTreeData = treeObject;
                        drawTree(currentTreeData);
                        console.log("Tree data loaded from Firestore.");
                    } catch (e) {
                        console.error("Error parsing JSON data from Firestore:", e);
                    }
                } else {
                    currentTreeData = { name: "Tree Document Empty" };
                    drawTree(currentTreeData);
                }
            } else {
                currentTreeData = JSON.parse(JSON.stringify(initialJsonStructure)); // Initialize with default structure
                drawTree(currentTreeData);
                console.log("Database not initialized. Using default structure.");
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            const authStatusElement = document.getElementById('authStatus');
            
            if (error.code === 'permission-denied') {
                authStatusElement.innerHTML = `<p class="text-xs text-red-500 font-bold mt-1">Error: Permission Denied. Please ensure the Firestore security rules allow unauthenticated public reads.</p>`;
                currentTreeData = { name: "Error: Permission Denied" };
                drawTree(currentTreeData);
            }
        });
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
    }

    loadTreeData();

    function resizeHandler() {
        if (currentTreeData) {
            drawTree(currentTreeData);
        }
    }

    // --- D3 LOGIC ---
    const initialJsonStructure = {
      name: "Jia Liok Ngo (Ancestor)", 
      children: [
        { name: "johnny", children: [{ name: "Magdalena" }, { name: "Yunita", children: [{ name: "Vince" }, { name: "Gwen" }] }, { name: "Juliana" }] },
        { name: "katerin" },
        { name: "justin", children: [{ name: "Yan", children: [{ name: "prina" }, { name: "nerva", children: [{ name: "razya" }] }, { name: "wiwin", children: [{ name: "lovna" }, { name: "ale" }] }] }, { name: "Op", children: [{ name: "irene", children: [{ name: "gemma" }] }, { name: "astrid" }] }, { name: "Irvan", children: [{ name: "fanny", children: [{ name: "mikha" }] }, { name: "vivian" }] }, { name: "yanty", children: [{ name: "janice" }, { name: "geo" }] }, { name: "wina", children: [{ name: "anet" }, { name: "serlin" }] }, { name: "irsan" }] },
        { name: "diana" },
        { name: "liance", children: [{ name: "nini", children: [{ name: "jason" }, { name: "janice" }] }, { name: "titi", children: [{ name: "justin" }, { name: "julian" }] }, { name: "tina", children: [{ name: "jeremy" }] }, { name: "victor", children: [{ name: "monic" }, { name: "jace" }] }] },
        { name: "tresnawati", children: [{ name: "vidya", children: [{ name: "Niko" }, { name: "Andre" }, { name: "Madeline" }] }, { name: "Viko", children: [{ name: "Adeline" }] }, { name: "Theo", children: [{ name: "Gerald" }, { name: "Kevin" }, { name: "Adelle" }] }, { name: "Siska", children: [{ name: "Angel" }, { name: "Nalda" }, { name: "Casia" }] }, { name: "Keke", children: [{ name: "Aldrich" }, { name: "Bryant (thatâ€™s me)" }, { name: "Christy" }] }] }
      ]
    };

    const nodeWidth = 100;
    const nodeHeight = 30;

    function drawTree(data) {
        if (!data || !data.name) return; 

        const container = document.getElementById('tree-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select("#tree")
            .attr("width", width)
            .attr("height", height);

        svg.selectAll('*').remove();

        const g = svg.append("g")
            .attr("transform", "translate(40,40)"); 

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4]) 
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        const treeLayout = d3.tree()
            .nodeSize([nodeHeight + 20, nodeWidth + 60]); 
            
        const root = d3.hierarchy(data);
        treeLayout(root);

        g.selectAll(".link")
            .data(root.links()) 
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y) 
                .y(d => d.x)); 

        const node = g.selectAll(".node")
            .data(root.descendants()) 
            .enter().append("g")
            .attr("class", d => "node" + (d.depth === 0 ? " node--root" : "") + (isAdminMode ? " node--admin" : "")) // Apply admin class
            .attr("transform", d => `translate(${d.y},${d.x})`); 

        node.append("rect")
            .attr("width", nodeWidth)
            .attr("height", nodeHeight)
            .attr("x", -(nodeWidth / 2))
            .attr("y", -(nodeHeight / 2)); 

        node.append("text")
            .attr("x", 0) 
            .attr("y", 0) 
            .text(d => d.data.name); 
            
        // Attach click handler ONLY if in Admin Mode
        if (isAdminMode) {
            node.on('click', (event, d) => {
                // Stop the zoom event from interfering with the click
                event.stopPropagation(); 
                openNodeEditModal(d);
            });
        }

        const initialScale = 0.7;
        svg.call(zoom.transform, d3.zoomIdentity
            .translate(width / 4, height / 2) 
            .scale(initialScale)
        );
    }
  </script>
</body>
</html>